.PHONY: run clean venv deps deps-dev test freeze freeze-dev

ROOT := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))
SCRIPTS := $(ROOT)scripts
VENV := $(ROOT).venv
PYTHON := $(VENV)/bin/python
PIP := $(VENV)/bin/pip

REQ := $(SCRIPTS)/spreadsheet_handling/requirements.txt
REQ_DEV := $(SCRIPTS)/spreadsheet_handling/requirements-dev.txt

run: venv deps
	$(SCRIPTS)/start_conversion.sh

test: venv deps-dev
	$(VENV)/bin/pytest $(SCRIPTS)/spreadsheet_handling/tests -q

clean:
	rm -rf $(SCRIPTS)/spreadsheet_handling/tmp
	find $(ROOT) -type d -name '__pycache__' -prune -exec rm -rf {} +
	find $(ROOT) -type d -name '.pytest_cache' -prune -exec rm -rf {} +
	find $(ROOT) -name '.~lock.*#' -delete

venv:
	@test -d $(VENV) || python3 -m venv $(VENV)

deps: venv
	$(PIP) install -r $(REQ)

deps-dev: venv
	$(PIP) install -r $(REQ_DEV)
	$(PIP) install -e scripts/spreadsheet_handling

freeze:
	$(PIP) freeze > $(REQ)

freeze-dev:
	$(PIP) freeze > $(REQ_DEV)

